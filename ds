#include "lvgl.h"

// ìŠ¤íƒ€ì¼ ì„ ì–¸
static lv_style_t style_bg;
static lv_style_t style_btn;
static lv_style_t style_disabled;
static lv_style_t style_focused;
static lv_style_t style_checked;

// ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” í•¨ìˆ˜
void init_styles() {
    // ğŸ”¹ ë°°ê²½ ìŠ¤íƒ€ì¼
    lv_style_init(&style_bg);
    lv_style_set_pad_all(&style_bg, 0);
    lv_style_set_pad_gap(&style_bg, 0);
    lv_style_set_clip_corner(&style_bg, true);
    lv_style_set_radius(&style_bg, LV_RADIUS_CIRCLE);
    lv_style_set_border_width(&style_bg, 0);

    // ğŸ”¹ ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼
    lv_style_init(&style_btn);
    lv_style_set_radius(&style_btn, 0);
    lv_style_set_border_width(&style_btn, 1);
    lv_style_set_border_opa(&style_btn, 0);

    // ğŸ”¹ Disabled(ë¹„í™œì„±í™”) ìƒíƒœ ìŠ¤íƒ€ì¼
    lv_style_init(&style_disabled);
    lv_style_set_bg_color(&style_disabled, lv_color_make(COLOR_DARK_BLUE)); // ê¸°ì¡´ ë°°ê²½ ìœ ì§€
    lv_style_set_text_opa(&style_disabled, LV_OPA_40);  // í…ìŠ¤íŠ¸ ë¶ˆíˆ¬ëª…ë„ 40%
    lv_style_set_text_color(&style_disabled, lv_color_make(COLOR_WHITE_RGB)); // ë¹„í™œì„±í™” ìƒíƒœì˜ ê¸€ììƒ‰

    // ğŸ”¹ Focused(ì´ˆì ) ìƒíƒœ ìŠ¤íƒ€ì¼
    lv_style_init(&style_focused);
    lv_style_set_bg_color(&style_focused, lv_color_make(COLOR_WHITE_RGB));  // ì´ˆì  ìƒíƒœ ë°°ê²½ìƒ‰ (í°ìƒ‰)
    lv_style_set_text_color(&style_focused, lv_color_make(COLOR_DARK_BLUE)); // ì´ˆì  ìƒíƒœ í…ìŠ¤íŠ¸ ìƒ‰ìƒ

    // ğŸ”¹ Checked(ì„ íƒë¨) ìƒíƒœ ìŠ¤íƒ€ì¼
    lv_style_init(&style_checked);
    lv_style_set_bg_color(&style_checked, lv_color_make(COLOR_BLUE_RGB)); // ì„ íƒëœ ìƒíƒœì˜ ë°°ê²½ ìƒ‰ìƒ
    lv_style_set_text_color(&style_checked, lv_color_make(COLOR_WHITE_RGB)); // ì„ íƒëœ ìƒíƒœì˜ ê¸€ììƒ‰
}

// ğŸ”¹ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ë¹„í™œì„±í™”ëœ ë²„íŠ¼ì„ ê±´ë„ˆëœ€)
void btnmatrix_event_handler(lv_event_t *e) {
    lv_obj_t *btnmatrix = lv_event_get_target(e);
    uint32_t btn_id = lv_btnmatrix_get_selected_btn(btnmatrix);

    lv_indev_t *indev = lv_event_get_indev(e);
    lv_key_t key = lv_indev_get_key(indev); // ì…ë ¥ëœ í‚¤ í™•ì¸ (ì˜ˆ: LV_KEY_LEFT, LV_KEY_RIGHT)

    uint32_t new_btn_id = btn_id; // í˜„ì¬ ë²„íŠ¼ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •

    if (key == LV_KEY_RIGHT) {  // â–¶ ì˜¤ë¥¸ìª½ ì´ë™
        while (new_btn_id < lv_btnmatrix_get_btn_count(btnmatrix) - 1) { 
            new_btn_id++;
            if (!lv_btnmatrix_has_btn_ctrl(btnmatrix, new_btn_id, LV_BTNMATRIX_CTRL_DISABLED)) {
                break;  // í™œì„±í™”ëœ ë²„íŠ¼ì„ ì°¾ìœ¼ë©´ ì¢…ë£Œ
            }
        }
    } else if (key == LV_KEY_LEFT) {  // â—€ ì™¼ìª½ ì´ë™
        while (new_btn_id > 0) { 
            new_btn_id--;
            if (!lv_btnmatrix_has_btn_ctrl(btnmatrix, new_btn_id, LV_BTNMATRIX_CTRL_DISABLED)) {
                break;  // í™œì„±í™”ëœ ë²„íŠ¼ì„ ì°¾ìœ¼ë©´ ì¢…ë£Œ
            }
        }
    }

    // ì°¾ì€ ë²„íŠ¼ìœ¼ë¡œ ì´ˆì  ì´ë™
    lv_btnmatrix_set_selected_btn(btnmatrix, new_btn_id);
}

// ğŸ”¹ ë²„íŠ¼ ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„± í•¨ìˆ˜
lv_obj_t* CreateKeyMatrix(lv_obj_t* pParent, UINT32 ulAlignment, INT16 x, INT16 y, const char** pBtnData, bool isScreenWidth) {
    // ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
    init_styles();

    lv_obj_t* btnm = lv_btnmatrix_create(pParent);
    lv_btnmatrix_set_map(btnm, pBtnData);
    
    // ìŠ¤íƒ€ì¼ ì ìš©
    lv_obj_add_style(btnm, &style_bg, LV_PART_MAIN);
    lv_obj_add_style(btnm, &style_btn, LV_PART_ITEMS);
    lv_obj_add_style(btnm, &style_disabled, LV_PART_ITEMS | LV_STATE_DISABLED);
    lv_obj_add_style(btnm, &style_focused, LV_PART_ITEMS | LV_STATE_FOCUSED | LV_STATE_FOCUS_KEY | LV_STATE_PRESSED);
    lv_obj_add_style(btnm, &style_checked, LV_PART_ITEMS | LV_STATE_CHECKED | LV_STATE_FOCUSED);

    if (isScreenWidth) {
        lv_obj_set_size(btnm, SCREEN_WIDTH, 48);
    }

    /* Allow selecting only one button at a time */
    lv_btnmatrix_set_btn_ctrl_all(btnm, LV_BTNMATRIX_CTRL_CHECKABLE);
    lv_btnmatrix_set_one_checked(btnm, true);
    lv_btnmatrix_set_btn_ctrl(btnm, 0, LV_BTNMATRIX_CTRL_CHECKED);

    // ğŸ”¹ íŠ¹ì • ë²„íŠ¼ ë¹„í™œì„±í™”
    lv_btnmatrix_set_btn_ctrl(btnm, 2, LV_BTNMATRIX_CTRL_DISABLED);  // 2ë²ˆ ë²„íŠ¼ ë¹„í™œì„±í™”
    lv_btnmatrix_set_btn_ctrl(btnm, 4, LV_BTNMATRIX_CTRL_DISABLED);  // 4ë²ˆ ë²„íŠ¼ ë¹„í™œì„±í™”

    lv_obj_set_style_text_font(btnm, &KR_FONT_20M, LV_PART_MAIN | LV_STATE_DEFAULT);

    // ê¸°ë³¸ ë°°ê²½ ìƒ‰ìƒ ì ìš©
    lv_obj_set_style_bg_color(btnm, lv_color_make(COLOR_DARK_BLUE), LV_PART_ITEMS);
    lv_obj_set_style_text_color(btnm, lv_color_make(COLOR_WHITE_RGB), LV_PART_ITEMS | LV_STATE_DEFAULT); // ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ

    // í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬
    lv_obj_set_style_text_align(btnm, LV_TEXT_ALIGN_CENTER, LV_PART_MAIN);
    lv_obj_align(btnm, ulAlignment, x, y);

    // ğŸ”¹ ë¹„í™œì„± ë²„íŠ¼ ì´ˆì  ì´ë™ ë°©ì§€ ì´ë²¤íŠ¸ ì¶”ê°€
    lv_obj_add_event_cb(btnm, btnmatrix_event_handler, LV_EVENT_KEY, NULL);

    return btnm;
}
